import{a as ri,d as Mi,i as Zi}from"./chunk-BWXSIBB4.js";import{$ as yi,O as $,P as K,Q as j,R as vi,W as Ii,X as P,aa as Q,ba as X,da as Vi,ia as Ri,ja as ji,na as wi,oa as Ai,pa as oi,ra as Oi,ta as Pi}from"./chunk-PJC2464E.js";import{C as ti,L as ni,Q as Si,T as W,W as zi,_ as B,da as y,f as ei,p as hi,q,r as fi,ra as si,rc as bi}from"./chunk-ZLZ2LL2Z.js";function z(O){return O==null?"":Array.isArray(O)?O[0]:O}function xi(O){let i=new Map;return e=>{let t=i.get(e);return t!=null||(t=O(e),i.set(e,t)),t}}var V="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-.",G=V.length,Ni=V.split("").reduce((O,i,e)=>(O[i]=e,O),{}),k=class k{constructor(){this.base64codes=new Uint8Array(256).fill(255);this.nToId=xi(i=>i/G>=1?this.nToId(Math.floor(i/G))+this.nToId(i%G):V[i]);this.idToN=xi(i=>{let e=Ni[i[0]];return i.length>1?(i=i.substring(1),e*Math.pow(G,i.length)+this.idToN(i)):e});for(let i=0;i<V.length;i++)this.base64codes[V.charCodeAt(i)]=i;this.base64codes[95]=0}async deflate(i){let e=await this.compress(i,"deflate");return this.bytesToBase64(e)}async inflate(i){try{return await this.inflateStr(i)}catch{console.warn("Router failed to parse url, checking for missing trailing characters...")}try{return await this.inflateMend(i,"-")}catch{}try{return await this.inflateMend(i,".")}catch{}return await this.inflateMend(i,"_")}async inflateMend(i,e){let t=await this.inflateStr(i+e);if(!t)throw new Error("Failed to parse, generated empty string");return console.warn(`Router mended url by appending '${e}'`),t}inflateStr(i){return this.decompress(this.base64ToBytes(i))}bytesToBase64(i){let e="",t,r=i.length;for(t=2;t<r;t+=3)e+=V[i[t-2]>>2],e+=V[(i[t-2]&3)<<4|i[t-1]>>4],e+=V[(i[t-1]&15)<<2|i[t]>>6],e+=V[i[t]&63];return t===r+1&&(e+=V[i[t-2]>>2],e+=V[(i[t-2]&3)<<4],e+="__"),t===r&&(e+=V[i[t-2]>>2],e+=V[(i[t-2]&3)<<4|i[t-1]>>4],e+=V[(i[t-1]&15)<<2],e+="_"),e}getBase64Code(i){if(i>=this.base64codes.length)throw new Error("Unable to parse base64 string.");let e=this.base64codes[i];if(e===255)throw new Error("Unable to parse base64 string.");return e}base64ToBytes(i){if(i.length%4!==0)throw new Error("Unable to parse base64 string.");let e=i.indexOf("_");if(e!==-1&&e<i.length-2)throw new Error("Unable to parse base64 string.");let t=i.endsWith("__")?2:i.endsWith("_")?1:0,r=i.length,s=new Uint8Array(3*(r/4)),n;for(let a=0,o=0;a<r;a+=4,o+=3)n=this.getBase64Code(i.charCodeAt(a))<<18|this.getBase64Code(i.charCodeAt(a+1))<<12|this.getBase64Code(i.charCodeAt(a+2))<<6|this.getBase64Code(i.charCodeAt(a+3)),s[o]=n>>16,s[o+1]=n>>8&255,s[o+2]=n&255;return s.subarray(0,s.length-t)}async compress(i,e="deflate"){let t=new TextEncoder().encode(i),r=new CompressionStream(e),s=r.writable.getWriter();s.write(t),s.close();let n=new Response(r.readable).arrayBuffer();return new Uint8Array(await n)}async decompress(i,e="deflate"){let t=new DecompressionStream(e),r=t.writable.getWriter();r.write(i).catch(()=>{}),r.close().catch(()=>{});let s=new Response(t.readable).arrayBuffer();return new TextDecoder().decode(await s)}};k.\u0275fac=function(e){return new(e||k)},k.\u0275prov=B({token:k,factory:k.\u0275fac,providedIn:"root"});var F=k;var N=class N{constructor(){this.compression=y(F)}zipFields(i){return i.join("*").replace(/\**$/,"")}zipString(i){return i??""}zipRational(i){return i==null?"":i.toString()}zipNumber(i){return i==null?"":i.toString()}zipArray(i){return i==null?"":i.length?i.join("~"):"_"}zipNString(i,e){return i==null?"":this.compression.nToId(e.indexOf(i))}zipDiffSubset(i,e,t,r=t){if(i==null||e!=null&&Array.from(i).every(c=>e.has(c)))return"";if(i.size===0)return"_";let s=new Set(t),n=[],a,o;return r.forEach((c,l)=>{if(s.has(c))if(i.has(c)){let d=this.compression.nToId(l);a==null?a=d:o=d}else a!=null&&(o==null?n.push(a):n.push(a+"~"+o),a=void 0,o=void 0)}),a!=null&&(o==null?n.push(a):n.push(a+"~"+o)),n.join("*")}zipDiffString(i,e,t){return i===e||i==null?"":[i,this.compression.nToId(t.indexOf(i))]}zipDiffNumber(i,e){return i===e||i==null?"":i.toString()}zipDiffRational(i,e){return i==null||e!=null&&i.eq(e)?"":i.toString()}zipDiffBool(i,e){return i===e?"":i?"1":"0"}zipDiffIndices(i,e){let t=i!=null?i.length>0?i.join("~"):"_":"",r=e!=null?e.length>0?e.join("~"):"_":"";return t===r?"":t}zipDiffArray(i,e,t){let r=i!=null?i.length>0?i.join("~"):"_":"",s=e!=null?e.length>0?e.join("~"):"_":"";return r===s?"":i==null||i.length===0?r:[r,i.map(n=>this.compression.nToId(t.indexOf(n))).join("~")]}parseString(i,e){if(e!=null)return this.parseNString(i,e);if(i?.length)return i}parseBool(i){if(i?.length)return i==="1"}parseNumber(i){if(i?.length)return Number(i)}parseRational(i){if(i?.length)return $(i)}parseArray(i,e){if(e)return this.parseNArray(i,e);if(i?.length)return i==="_"?[]:i.split("~")}parseIndices(i,e){if(i?.length)return i==="_"?[]:i.split("~").map(t=>Number(t)).map(t=>e[t]??{})}parseNString(i,e){let t=this.parseString(i);return t==null?t:e[this.compression.idToN(t)]}parseNArray(i,e){let t=this.parseArray(i);return t==null?t:t.map(r=>e[this.compression.idToN(r)])}parseSubset(i,e){if(!i?.length)return;if(i==="_")return new Set;let t=i.split("*"),r=new Set;for(let s of t){let[n,a]=s.split("~").map(l=>this.compression.idToN(l)),o=a!=null?a+1:n+1;e.slice(n,o).forEach(l=>r.add(l))}return r}set(i,e,t){return r=>(s,n,...a)=>{let o=n(e),c=n(t),l=r(o,c,...a),d,g;Array.isArray(l)?[d,g]=[...l]:d=g=l,d&&(i.bare[s]=d,i.hash[s]=g)}}get(i){return e=>(e=e.bind(this),(t,...r)=>e(i[t],...r))}};N.\u0275fac=function(e){return new(e||N)},N.\u0275prov=B({token:N,factory:N.\u0275fac,providedIn:"root"});var U=N;var h="_",J="?",C="=";var T=class T{constructor(){this.compression=y(F);this.translate=y(yi);this.zip=y(U)}migrate(i,e){if(Object.keys(e).length===0)return{modId:i??Q,params:{},isBare:!0};e=K(e);let t=P(e.v,"0");Ii("unzip_version",t);let r=e.z==null;(r||t==="0")&&Object.keys(e).forEach(a=>{Array.isArray(e[a])?e[a]=e[a].map(o=>decodeURIComponent(o)):e[a]&&(e[a]=decodeURIComponent(e[a]))});let s=this.migrateAny(i,e,r,t);return this.displayWarnings(s.warnings),["o","i","r","m","e","b"].forEach(a=>{let o=s.params[a];typeof o=="string"&&(s.params[a]=[o])}),{modId:s.modId,params:s.params,isBare:s.isBare}}migrateAny(i,e,t,r){let n={modId:i,params:e,warnings:[],isBare:t};switch(r){case"0":return this.migrateV0(n);case"1":return this.migrateV1(n);case"2":return this.migrateV2(n);case"3":return this.migrateV3(n);case"4":return this.migrateV4(n);case"5":return this.migrateV5(n);case"6":return this.migrateV6(n);case"7":return this.migrateV7(n);case"8":return this.migrateV8(n);case"9":return this.migrateV9(n);case"10":return this.migrateV10(n);default:return n}}migrateV0(i){let{params:e}=i;if(e.s){let r=z(e.s).split("*"),s=this.zip.parseString(r[0]);s=s&&X.modHash[X.modHashV0.indexOf(s)],s=s??"";let n=this.zip.parseNumber(r[6])??60,a=n===1?"0":n===3600?"2":"1";e.s=this.zip.zipFields([s,a,z(e.b),r[1],r[3],r[4],r[5],r[7],r[8],r[10],r[9],r[2],r[11],r[12]])}else e.b&&(e.s=this.zip.zipFields([J,J,z(e.b)]));return delete e.b,e.v="1",this.migrateV1(i)}migrateV1(i){let{params:e,warnings:t}=i;if(e.s){let s=z(e.s).split("*"),n=11;if(s.length>n){let a=s.splice(n,1);this.zip.parseBool(a[0])&&t.push("The expensive setting has been removed. Please use or request an expensive data set instead.")}e.s=this.zip.zipFields(s)}return e.v="4",this.migrateV4(i)}migrateV2(i){let{params:e}=i;if(e.r){let r=z(e.r).split(h),s=[],n=3;for(let a of r){let o=a.split("*");if(o.length>n){let c=this.parseNNumber(o[n])?.toString();o[n]=this.zip.zipString(c)}s.push(this.zip.zipFields(o))}e.r=s.join(h)}if(e.f){let r=z(e.f).split(h),s=[],n=2;for(let a of r){let o=a.split("*");if(o.length>n){let c=this.parseNNumber(o[n])?.toString();o[n]=this.zip.zipString(c)}s.push(this.zip.zipFields(o))}e.f=s.join(h)}return e.v="3",this.migrateV3(i)}migrateV3(i){let{params:e,warnings:t}=i;if(e.s){let s=z(e.s).split("*"),n=10;if(s.length>n){let a=s.splice(n,1);this.zip.parseBool(a[0])&&t.push("The expensive setting has been removed. Please use or request an expensive data set instead.")}e.s=this.zip.zipFields(s)}return e.v="5",this.migrateV5(i)}migrateInlineBeaconsSection(i,e,t,r){if(i[e]){let n=z(i[e]).split(h),a=[];for(let o of n.map(c=>c.split("*"))){let c=t+1,l=c+1,d=l+3;if(o.length>t){let g,u,M;o.length>d&&(M=o.splice(d,1)[0]),o.length>l&&(g=o.splice(l,1)[0]),o.length>c&&(u=o.splice(c,1)[0]);let p=o[t];o[t]=this.zip.zipArray([r.length]),r.push(this.zip.zipFields([p,this.zip.zipString(u),this.zip.zipString(g),this.zip.zipString(M)]))}a.push(this.zip.zipFields(o))}i[e]=a.join(h)}}migrateInlineBeacons(i){let e=[];return this.migrateInlineBeaconsSection(i.params,"q",4,e),this.migrateInlineBeaconsSection(i.params,"r",3,e),e.length&&(i.params.e=e.join(h)),i}migrateV4(i){return i=this.migrateInlineBeacons(i),i.params.v="6",this.migrateV6(i)}migrateV5(i){return i=this.migrateInlineBeacons(i),i.params.v="7",this.migrateV7(i)}migrateInsertField(i,e,t){if(i[e]){let r=z(i[e]).split(h);for(let s=0;s<r.length;s++){let n=r[s].split("*");n.length>t&&(n.splice(t,0,""),r[s]=this.zip.zipFields(n))}i[e]=r.join(h)}}migrateDeleteField(i,e,t){if(i[e]){let r=z(i[e]).split(h);for(let s=0;s<r.length;s++){let n=r[s].split("*");n.length>t&&(n.splice(t,1),r[s]=this.zip.zipFields(n))}i[e]=r.join(h)}}migrateMoveUpField(i,e,t){if(i[e]!=null){let r=i[e];for(i.splice(e,1),i.length>t&&i.splice(t,0,"");i.length<=t;)i.push("");i[t]=r}}migrateToV8(i){let{params:e,isBare:t}=i,r=!1;if(this.migrateInsertField(e,"q",2),e.p){let s=z(e.p).split(h),n=[...s];for(let a=0;a<s.length;a++){let c=s[a].split("*");if(c[2]==="3")if(t){let l=e.q?z(e.q).split(h):[];if(c.length>3){let d=[c[3],c[1],3 .toString()],g=[c[0],"1",2 .toString()];l.push(this.zip.zipFields(g)),l.push(this.zip.zipFields(d)),r=!0}else l.push(this.zip.zipFields([c[0],c[1]]));n.splice(a,1),e.q=l.join(h)}else c[2]="0",n[a]=this.zip.zipFields(c);else if(c.length>3){let l=[c[3],c[1],c[2],3 .toString()],d=[c[0],"1","",2 .toString()];n[a]=this.zip.zipFields(d),n.push(this.zip.zipFields(l)),r=!0}}r&&i.warnings.push("Limit steps have been replaced by limit objectives. Results may differ if using multiple objectives as limits apply to all objectives."),e.p=n.join(h)}if(this.migrateDeleteField(e,"i",4),this.migrateInsertField(e,"r",1),e.s){let s=z(e.s).split("*"),n=t?1:0;if(s.length>2+n){let a=this.zip.parseArray(s[2+n].replaceAll(C,"_"));if(a){let o=z(e.r),c=o?o.split(h):[];for(let l of a){let d=!1;for(let g=0;g<c.length;g++){let u=c[g].split("*");u[0]===l&&(d=!0,u[1]="1",c[g]=this.zip.zipFields(u))}d||c.push(this.zip.zipFields([l,"1"]))}e.r=c.join(h)}s.splice(2+n,1)}s.splice(n,0,""),this.migrateMoveUpField(s,16+n,20+n),this.migrateMoveUpField(s,15+n,19+n),this.migrateMoveUpField(s,14+n,18+n),this.migrateMoveUpField(s,13+n,17+n),e.s=this.zip.zipFields(s)}return e.v="8",i}migrateV6(i){return i.isBare=!0,this.migrateV8(this.migrateToV8(i))}migrateV7(i){return i.isBare=!1,this.migrateV8(this.migrateToV8(i))}migrateV8(i){let{params:e}=i;if(e.q){let t=[];e.p&&(t=z(e.p).split(h));let r=z(e.q).split(h);for(let s of r){let n=s.split("*"),a=this.zip.zipFields([n[0],n[1],"3",n[2],n[3],n[4],n[5],n[6],n[7]]);t.push(a)}e.q="",e.p=t.join(h)}return this.migrateV9(i)}migrateInlineModulesSection(i,e,t,r){if(i[e]){let n=z(i[e]).split(h),a=[];for(let o of n.map(c=>c.split("*"))){if(o.length>t){let c=o[t],l=this.zip.parseArray(c);if(l==null)continue;let d=new Map;for(let u of l){let M=d.get(u)??0;d.set(u,M+1)}let g=Array.from(d.keys()).map((u,M)=>r.length+M);o[t]=this.zip.zipArray(g);for(let u of d.keys())r.push(this.zip.zipFields([P(d.get(u)?.toString(),""),u]))}a.push(this.zip.zipFields(o))}i[e]=a.join(h)}}migrateV9(i){let{params:e}=i,t=[];if(this.migrateInlineModulesSection(i.params,"e",1,t),this.migrateInlineModulesSection(i.params,"r",3,t),this.migrateInlineModulesSection(i.params,"p",5,t),i.params.f){let s=z(e.f).split(h),n=[],a=i.params.e?z(i.params.e).split(h):[],o=2,c=o+1,l=c+1;s.map(d=>d.split("*")).forEach((d,g)=>{if(g===0&&d[0]==="1"&&(d[0]=C),this.migrateMoveUpField(d,5,6),d[0]!==C&&d[0]!==""&&d.length>1){let u=d[1];if(u){let M=u.split("~")[0];d[1]=this.zip.zipArray([t.length]),t.push(this.zip.zipFields(["",M]))}}if(d.length>2){let u,M;if(d.length>l&&(u=d.splice(l,1)[0]),d.length>c){let b=d.splice(c,1)[0];if(b){let w=b.split("~")[0];M=[t.length],t.push(this.zip.zipFields(["",w]))}}let p=d[o];d[o]=this.zip.zipArray([a.length]),a.push(this.zip.zipFields([p,this.zip.zipArray(M),this.zip.zipString(u)]))}n.push(this.zip.zipFields(d))}),a.length&&(i.params.e=a.join(h)),i.params.f=n.join(h)}if(t.length&&(i.params.m=t.join(h)),e.s){let r=z(e.s).split("*"),s=i.isBare?5:4;if(r.length>s){let n=r.splice(s,1)[0];if(e.f){let a=z(e.f).split(h).map(c=>c.split("*")),o=a.find(c=>c[0]===C||c[0]==="");if(o){for(;o.length<4;)o.push("");o[3]=n}else a.unshift(["","","",n]);e.f=a.map(c=>this.zip.zipFields(c)).join(h)}else e.f=["","","",n].join("*");e.s=r.join("*")}}return e.v="10",this.migrateV10(i)}migrateV10(i){let{params:e}=i;delete e.q;let t=new Set,r=new Set,s=new Set,n=new Set,a=new Set;function o(S,f){f.size!==0&&(e[S]=Array.from(f).join("~"))}let c=e.m;delete e.m;let l=c?.split(h),d=e.e;delete e.e;let g=d?.split(h),u=e.p;delete e.p;let M=[],p=u?.split(h).map((S,f)=>{let v=S.split("*"),E=f.toString();return M.push(E),v[8]==="1"&&t.add(E),v.splice(8,1),v.join("*")}).filter(S=>S);p?.length&&(e.o=p),t.size&&(e.och=this.zip.zipDiffSubset(t,void 0,M));let b=e.i;delete e.i;let w=b?.split(h).map(S=>{let f=S.split("*"),v=f[0];return f[1]==="1"&&r.add(v),f[4]==="1"&&s.add(v),f.splice(4,1),f.splice(1,1),f.join("*")}).filter(S=>S);w?.length&&(e.i=w),o("v10iex",r),o("v10ich",s);let A=e.r;delete e.r;let x=A?.split(h).map(S=>{let f=S.split("*"),v=f[0];return f[1]==="1"&&n.add(v),f[7]==="1"&&a.add(v),f.splice(7,1),f.splice(1,1),f.join("*")}).filter(S=>S);x?.length&&(e.r=x),o("v10rex",n),o("v10rch",a);let Fi=e.f;delete e.f;let Y,ci,pi,di,li,ii=[];Fi?.split(h).forEach((S,f)=>{let v=S.split("*"),E=v[0];f===0?(E===C&&(Y=[]),pi=v[1],di=v[2],ci=v[3],li=v[4]):(Y?.push(E),v.length>1&&ii.push(S))}),ii.length&&(e.m=ii),e.mmr=Y?.join("~"),e.mfr=ci,e.mer=pi,e.mbe=di,e.moc=li;let gi=e.s;if(delete e.s,gi){let S=gi.split("*"),f=i.isBare?S.splice(0,1)[0]:void 0;f&&(i.modId=f);let v=S[0];v&&v!==J&&o("v10tre",new Set(v.split("~"))),["odr","mpr","ibe","ifr","bmi","bre","bic","mit","icw","ifw","ipi","mbr","mps","rnp","omt","cfa","cma","cun","cex","csu","cmx","osm","cfp"].forEach((mi,L)=>{e[mi]=S[L+1]||void 0}),i.isBare||["ifr","bmi","bre","omt"].filter(L=>e[L]!=null).forEach(L=>{e[L]=this.parseNNumber(z(e[L]))?.toString()})}let ki=e.b;delete e.b;let H=ki;H&&!i.isBare&&(H=X.modHash[this.compression.idToN(H)]),H&&(i.modId=H),e.e=l,e.b=g,e.v="11",j(e);function ui(S){return S.replaceAll(J,"").replaceAll(C,"_")}return Object.keys(e).forEach(S=>{let f=e[S];Array.isArray(f)?e[S]=f.map(v=>ui(v)):f&&(e[S]=ui(f))}),i}restoreV10ResearchedTechnologies(i,e){let t=e.items.filter(o=>o.technology),r=t.map(o=>o.id);if(i==null||!r.length)return;let s=new Set(i),n=Vi(t),a;do{a=new Set;for(let o of s)n[o].technology?.prerequisites?.filter(l=>!s.has(l)).forEach(l=>a.add(l));a.forEach(o=>s.add(o))}while(a.size);if(s.size!==r.length)return s}parseNNumber(i){if(i?.length)return this.compression.idToN(i)}parseSet(i,e){if(i==null)return;let t=i.split("~");return e==null?new Set(t):new Set(t.map(r=>e[this.compression.idToN(r)]))}displayWarnings(i){i.length!==0&&alert(i.join(`
`))}};T.\u0275fac=function(e){return new(e||T)},T.\u0275prov=B({token:T,factory:T.\u0275fac,providedIn:"root"});var _=T;var Li=200,D=class D{constructor(){this.router=y(Mi);this.compression=y(F);this.itemsStore=y(wi);this.machinesStore=y(Ai);this.migration=y(_);this.objectivesStore=y(Pi);this.recipesStore=y(Oi);this.fileClient=y(Zi);this.settingsStore=y(ji);this.zip=y(U);this.state$=new ei;this.zipConfig=si(this.empty);this.version="11";this.zipTail={v:this.version};this.route$=new ei;this.ready=si(!1);this.navigating$=this.router.events.pipe(q(i=>i.type!==ri.NavigationEnd&&i.type!==ri.NavigationSkipped),Si(1));this.stored=vi("router");this.route$.pipe(W(i=>fi({params:i.params,queryParams:i.queryParams})),ti(()=>this.navigating$.pipe(ni(i=>!i))),W(async({params:i,queryParams:e})=>(e=await this.unzipQueryParams(e),{params:i,queryParams:e})),q(({params:i,queryParams:e})=>this.migration.migrate(i.id,e)),W(({modId:i,params:e,isBare:t})=>this.updateState(i,e,t))).subscribe(),bi(()=>{let i=this.ready(),e=this.settingsStore.hash();if(!i||!e)return;let t=this.objectivesStore.state(),r=this.itemsStore.state(),s=this.recipesStore.state(),n=this.machinesStore.state(),a=this.settingsStore.state(),o=this.settingsStore.dataset();this.state$.next({objectives:t,items:r,recipes:s,machines:n,settings:a,data:o,hash:e})}),this.state$.pipe(q(i=>this.zipState(i)),zi(i=>{this.zipConfig.set(i.config)}),ti(()=>this.navigating$.pipe(ni(i=>!i))),W(i=>this.updateUrl(i))).subscribe()}get empty(){return{bare:{},hash:{}}}get emptyRecipeSettingsInfo(){return{idMap:{},list:[]}}get emptyMachineSettings(){return{moduleMap:{},beaconMap:{}}}async updateUrl(i){let e=await this.getHash(i);await this.router.navigate([],{queryParams:e});let t=this.router.url,r=t.split("?")[0];(r.endsWith("list")||r.endsWith("flow"))&&this.stored.set(t)}zipState(i){let{objectives:e,items:t,recipes:r,machines:s,settings:n,data:a,hash:o}=i,c=this.zipModulesBeacons(e,r,s,n,o);return this.zipObjectives(c,e,o),this.zipItems(c,t,o),this.zipRecipes(c,r,o),this.zipMachines(c,s,o),this.zipSettings(c,n,Object.keys(e),a,o),c}async stepHref(i,e,t){if(t==null)return null;let r;if(i.itemId!=null&&i.items!=null?r={1:{id:"1",targetId:i.itemId,value:i.items,unit:0,type:0}}:i.recipeId!=null&&i.machines!=null&&(r={1:{id:"1",targetId:i.recipeId,value:i.machines,unit:3,type:0}}),r==null)return null;let s={objectives:this.empty,config:e,objectiveSettings:this.emptyMachineSettings,recipeSettings:this.emptyMachineSettings,machineSettings:this.emptyMachineSettings};return this.zipObjectives(s,r,t),await this.getHash(s)}async getHashParams(i){let e=this.toString(i);return{z:await this.compression.deflate(e),v:this.version}}async getHash(i){let e=K(i.objectives.bare,i.config.bare,this.zipTail);if(Object.keys(e).length===1)return{};let t=K(i.objectives.hash,i.config.hash,this.zipTail),r=await this.getHashParams(t),n=this.toString(e).length,o=this.toString(r).length;return n<Math.max(o,Li)?e:r}toParams(i){let e=i.split("&");return e.some(t=>!t.includes("="))?e.reduce((t,r)=>(t[r[0]]=r.substring(1),t),{}):e.reduce((t,r)=>{let[s,n]=r.split("=");return t[s]==null?t[s]=n:Array.isArray(t[s])?t[s].push(n):t[s]=[t[s],n],t},{})}toString(i){return Object.keys(i).flatMap(e=>{let t=i[e];return Array.isArray(t)?t.map(r=>`${e}=${r}`):t?`${e}=${t}`:[]},"").join("&")}async unzipQueryParams(i){let e=i.z;if(e!=null)try{let t=z(e).replace(/\+/g,"-").replace(/\//g,".").replace(/=/g,"_"),r=await this.compression.inflate(t);i=this.toParams(r),i.z=e}catch(t){throw console.error(t),new Error("RouterService failed to parse url")}return i}async updateState(i,e,t){if(i==null&&Object.keys(e).length===0){this.ready.set(!0);return}let[r,s]=await hi(this.fileClient.requestData(i??Q)),n=t?void 0:s,a=this.unzipModules(e,n),o=this.unzipBeacons(e,a,n),c={};c.objectivesState=this.unzipObjectives(e,a,o,n),c.itemsState=this.unzipItems(e,n),c.recipesState=this.unzipRecipes(e,a,o,n),c.machinesState=this.unzipMachines(e,a,o,n);let l=c.objectivesState?Object.keys(c.objectivesState):[];c.settingsState=this.unzipSettings(i,e,o,l,r,s,n),this.dispatch(c)}dispatch(i){this.objectivesStore.load(i.objectivesState),this.itemsStore.load(i.itemsState),this.recipesStore.load(i.recipesState),this.machinesStore.load(i.machinesState),this.settingsStore.load(i.settingsState),this.ready.set(!0)}zipModulesBeacons(i,e,t,r,s){let n=this.emptyRecipeSettingsInfo,a=this.emptyRecipeSettingsInfo,o=b=>this.zipMachineSettings(b,n,a,s),c=o(i),l=o(e),d=o(t),g;if(r.beacons){let b=this.beaconModuleMap(r.beacons,n,s);g=this.zipBeaconArray(r.beacons,b,a,s)}let u=this.empty,M=["bare","hash"];return[["e",n.list],["b",a.list]].forEach(([b,w])=>{w.forEach(A=>{M.forEach(x=>{u[x][b]==null?u[x][b]=[A[x]]:u[x][b].push(A[x])})})}),{objectives:this.empty,config:u,objectiveSettings:c,recipeSettings:l,machineSettings:d,beacons:g}}zipMachineSettings(i,e,t,r){let s=this.emptyMachineSettings;for(let n of Object.keys(i)){let a=i[n];if(a.modules!=null&&(s.moduleMap[n]=this.zipModuleArray(a.modules,e,r)),a.beacons!=null){let o=this.beaconModuleMap(a.beacons,e,r);s.beaconMap[n]=this.zipBeaconArray(a.beacons,o,t,r)}}return s}beaconModuleMap(i,e,t){return i.map(r=>{if(r.modules!=null)return this.zipModuleArray(r.modules,e,t)})}zipModuleArray(i,e,t){return i.map(r=>{let s=this.zip.zipRational(r.count),n={bare:this.zip.zipFields([s,this.zip.zipString(r.id)]),hash:this.zip.zipFields([s,this.zip.zipNString(r.id,t.modules)])};return e.idMap[n.bare]==null&&(e.idMap[n.bare]=e.list.length,e.list.push(n)),e.idMap[n.bare]})}unzipModules(i,e){return i.e==null?[]:i.e.map(t=>{let r=t.split("*"),s=0,n={count:this.zip.parseRational(r[s++]),id:this.zip.parseString(r[s++],e?.modules)};return j(n),n})}zipBeaconArray(i,e,t,r){return i.map((s,n)=>{let a=this.zip.zipRational(s.count),o=this.zip.zipArray(e[n]),c=this.zip.zipRational(s.total),l={bare:this.zip.zipFields([a,o,this.zip.zipString(s.id),c]),hash:this.zip.zipFields([a,o,this.zip.zipNString(s.id,r.beacons),c])};return t.idMap[l.bare]==null&&(t.idMap[l.bare]=t.list.length,t.list.push(l)),t.idMap[l.bare]})}unzipBeacons(i,e,t){return i.b==null?[]:i.b.map(r=>{let s=r.split("*"),n=0,a={count:this.zip.parseRational(s[n++]),modules:this.zip.parseIndices(s[n++],e),id:this.zip.parseString(s[n++],t?.beacons),total:this.zip.parseRational(s[n++])};return j(a),a})}zipObjectives(i,e,t){let r=Object.keys(e);if(!r.length)return;let s=r.map(n=>e[n]);i.objectives.bare.o=[],i.objectives.hash.o=[];for(let n of s){let a=this.zip.zipDiffRational(n.value,$.one),o=this.zip.zipDiffNumber(n.unit,0),c=this.zip.zipDiffNumber(n.type,0),l=this.zip.zipArray(i.objectiveSettings.moduleMap[n.id]),d=this.zip.zipArray(i.objectiveSettings.beaconMap[n.id]),g=this.zip.zipNumber(n.overclock);i.objectives.bare.o.push(this.zip.zipFields([n.targetId,a,o,c,this.zip.zipString(n.machineId),l,d,g,this.zip.zipString(n.fuelId)])),i.objectives.hash.o.push(this.zip.zipFields([this.zip.zipNString(n.targetId,oi(n)?t.recipes:t.items),a,o,c,this.zip.zipNString(n.machineId,t.machines),l,d,g,this.zip.zipNString(n.fuelId,t.fuels)]))}}unzipObjectives(i,e,t,r){if(i.o==null)return;let s={},n=1;for(let a of i.o){let o=a.split("*"),c=0,l=n.toString(),d={id:n.toString(),targetId:o[c++],value:P(this.zip.parseRational(o[c++]),$.one),unit:this.zip.parseNumber(o[c++])??0,type:this.zip.parseNumber(o[c++])??0,machineId:this.zip.parseString(o[c++],r?.machines),modules:this.zip.parseIndices(o[c++],e),beacons:this.zip.parseIndices(o[c++],t),overclock:this.zip.parseRational(o[c++]),fuelId:this.zip.parseString(o[c++],r?.fuels)};r&&(d.targetId=P(this.zip.parseNString(d.targetId,oi(d)?r.recipes:r.items),"")),j(d),s[l]=d,n++}return s}zipItems(i,e,t){let r=Object.keys(e);if(r.length){i.config.bare.i=[],i.config.hash.i=[];for(let s of r){let n=e[s];i.config.bare.i.push(this.zip.zipFields([s,this.zip.zipString(n.beltId),this.zip.zipString(n.wagonId),this.zip.zipRational(n.stack)])),i.config.hash.i.push(this.zip.zipFields([this.zip.zipNString(s,t.items),this.zip.zipNString(n.beltId,t.belts),this.zip.zipNString(n.wagonId,t.wagons),this.zip.zipRational(n.stack)]))}}}unzipItems(i,e){if(i.i==null)return;let t={};for(let r of i.i){let s=r.split("*"),n=0,a=P(this.zip.parseString(s[n++],e?.items),""),o={beltId:this.zip.parseString(s[n++],e?.belts),wagonId:this.zip.parseString(s[n++],e?.wagons),stack:this.zip.parseRational(s[n++])};j(o),Object.keys(o).length&&(t[a]=o)}return t}zipRecipes(i,e,t){let r=Object.keys(e);if(r.length){i.config.bare.r=[],i.config.hash.r=[];for(let s of r){let n=e[s],a=this.zip.zipArray(i.recipeSettings.moduleMap[s]),o=this.zip.zipArray(i.recipeSettings.beaconMap[s]),c=this.zip.zipNumber(n.overclock),l=this.zip.zipNumber(n.cost),d=this.zip.zipNumber(n.productivity);i.config.bare.r.push(this.zip.zipFields([s,this.zip.zipString(n.machineId),a,o,c,l,this.zip.zipString(n.fuelId),d])),i.config.hash.r.push(this.zip.zipFields([this.zip.zipNString(s,t.recipes),this.zip.zipNString(n.machineId,t.machines),a,o,c,l,this.zip.zipNString(n.fuelId,t.fuels),d]))}}}unzipRecipes(i,e,t,r){if(i.r==null)return;let s={};for(let n of i.r){let a=n.split("*"),o=0,c=P(this.zip.parseString(a[o++],r?.recipes),""),l={machineId:this.zip.parseString(a[o++],r?.machines),modules:this.zip.parseArray(a[o++])?.map(d=>e[Number(d)]??{}),beacons:this.zip.parseArray(a[o++])?.map(d=>t[Number(d)]??{}),overclock:this.zip.parseRational(a[o++]),cost:this.zip.parseRational(a[o++]),fuelId:this.zip.parseString(a[o++],r?.fuels),productivity:this.zip.parseRational(a[o++])};j(l),Object.keys(l).length&&(s[c]=l)}return s}zipMachines(i,e,t){let r=Object.keys(e);if(r.length){i.config.bare.m=[],i.config.hash.m=[];for(let s of r){let n=e[s],a=this.zip.zipArray(i.machineSettings.moduleMap[s]),o=this.zip.zipArray(i.machineSettings.beaconMap[s]),c=this.zip.zipNumber(n.overclock);i.config.bare.m.push(this.zip.zipFields([s,a,o,this.zip.zipString(n.fuelId),c])),i.config.hash.m.push(this.zip.zipFields([this.zip.zipNString(s,t.machines),a,o,this.zip.zipNString(n.fuelId,t.fuels),c]))}}}unzipMachines(i,e,t,r){if(i.m==null)return;let s={};for(let n of i.m){let a=n.split("*"),o=0,c=P(this.zip.parseString(a[o++],r?.machines),""),l={modules:this.zip.parseArray(a[o++])?.map(d=>e[Number(d)]??{}),beacons:this.zip.parseArray(a[o++])?.map(d=>t[Number(d)]??{}),fuelId:this.zip.parseString(a[o++],r?.fuels),overclock:this.zip.parseRational(a[o++])};j(l),Object.keys(l).length&&(s[c]=l)}return s}zipSettings(i,e,t,r,s){let n=Ri,a=this.zip.set(i.config,e,n),o=a(this.zip.zipDiffSubset.bind(this.zip)),c=a(this.zip.zipDiffNumber.bind(this.zip)),l=a(this.zip.zipDiffBool.bind(this.zip)),d=a(this.zip.zipDiffString.bind(this.zip)),g=a(this.zip.zipDiffRational.bind(this.zip)),u=a(this.zip.zipDiffArray.bind(this.zip)),M=a(this.zip.zipDiffIndices.bind(this.zip));o("och",p=>p.checkedObjectiveIds,t),c("omt",p=>p.maximizeType),l("orm",p=>p.requireMachinesOutput),c("odr",p=>p.displayRate),o("iex",p=>p.excludedItemIds,r.itemIds,s.items),o("ich",p=>p.checkedItemIds,r.itemIds,s.items),d("ibe",p=>p.beltId,s.belts),d("ipi",p=>p.pipeId,s.belts),d("icw",p=>p.cargoWagonId,s.wagons),d("ifw",p=>p.fluidWagonId,s.wagons),g("ifr",p=>p.flowRate),g("ist",p=>p.stack),o("rex",p=>p.excludedRecipeIds,r.recipeIds,s.recipes),o("rch",p=>p.checkedRecipeIds,r.recipeIds,s.recipes),l("rnp",p=>p.netProductionOnly),c("mpr",p=>p.preset),u("mmr",p=>p.machineRankIds,s.machines),u("mfr",p=>p.fuelRankIds,s.fuels),u("mer",p=>p.moduleRankIds,s.modules),M("mbe",p=>p===n?void 0:i.beacons),g("moc",p=>p.overclock),g("mbr",p=>p.beaconReceivers),d("mps",p=>p.proliferatorSprayId,s.modules),c("mit",p=>p.inserterTarget),g("bmi",p=>p.miningBonus),g("bre",p=>p.researchBonus),c("bic",p=>p.inserterCapacity),o("tre",p=>p.researchedTechnologyIds,r.technologyIds,s.technologies),o("loc",p=>p.locationIds,r.locationIds,s.locations??[]),g("cfa",p=>p.costs.factor),g("cma",p=>p.costs.machine),g("cfp",p=>p.costs.footprint),g("cun",p=>p.costs.unproduceable),g("cex",p=>p.costs.excluded),g("csu",p=>p.costs.surplus),g("cmx",p=>p.costs.maximize),g("cre",p=>p.costs.recycling)}unzipSettings(i,e,t,r,s,n,a){let o=this.zip.get(e),c=o(this.zip.parseSubset.bind(this.zip)),l=o(this.zip.parseNumber.bind(this.zip)),d=o(this.zip.parseBool.bind(this.zip)),g=o(this.zip.parseString.bind(this.zip)),u=o(this.zip.parseRational.bind(this.zip)),M=o(this.zip.parseArray.bind(this.zip)),p=o(this.zip.parseIndices.bind(this.zip)),b={modId:i,checkedObjectiveIds:c("och",r),maximizeType:l("omt"),requireMachinesOutput:d("orm"),displayRate:l("odr"),excludedItemIds:c("iex",n.items),checkedItemIds:c("ich",n.items),beltId:g("ibe",a?.belts),pipeId:g("ipi",a?.belts),cargoWagonId:g("icw",a?.wagons),fluidWagonId:g("ifw",a?.wagons),flowRate:u("ifr"),stack:u("ist"),excludedRecipeIds:c("rex",n.recipes),checkedRecipeIds:c("rch",n.recipes),netProductionOnly:d("rnp"),preset:l("mpr"),machineRankIds:M("mmr",a?.machines),fuelRankIds:M("mfr",a?.fuels),moduleRankIds:M("mer",a?.modules),beacons:p("mbe",t),overclock:u("moc"),beaconReceivers:u("mbr"),proliferatorSprayId:g("mps",a?.modules),inserterTarget:l("mit"),miningBonus:u("bmi"),researchBonus:u("bre"),inserterCapacity:l("bic"),researchedTechnologyIds:c("tre",n.technologies),locationIds:c("loc",n.locations??[])},w={factor:u("cfa"),machine:u("cma"),footprint:u("cfp"),unproduceable:u("cun"),excluded:u("cex"),surplus:u("csu"),maximize:u("cmx"),recycling:u("cre")},A=this.migration.parseSet.bind(this.migration);if(e.v10iex&&(b.excludedItemIds=A(e.v10iex,a?.items)),e.v10ich&&(b.checkedItemIds=A(e.v10ich,a?.items)),e.v10rex&&(b.excludedRecipeIds=A(e.v10rex,a?.recipes)),e.v10rch&&(b.checkedRecipeIds=A(e.v10rch,a?.recipes)),e.v10tre&&(b.researchedTechnologyIds=A(e.v10tre,a?.technologies),b.researchedTechnologyIds=this.migration.restoreV10ResearchedTechnologies(b.researchedTechnologyIds,s)),j(w),Object.keys(w).length&&(b.costs=w),j(b),!!Object.keys(b).length)return b}};D.\u0275fac=function(e){return new(e||D)},D.\u0275prov=B({token:D,factory:D.\u0275fac,providedIn:"root"});var Bi=D;export{_ as a,Bi as b};
